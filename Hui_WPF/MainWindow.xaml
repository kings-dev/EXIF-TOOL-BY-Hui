<Window x:Class="Hui_WPF.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:Hui_WPF"
        xmlns:models="clr-namespace:Hui_WPF.Models"
        xmlns:system="clr-namespace:System;assembly=mscorlib"
        xmlns:vm="clr-namespace:Hui_WPF.ViewModels"
        xmlns:converters="clr-namespace:Hui_WPF.Converters"
        mc:Ignorable="d"
        Title="ExifDog" Height="950" Width="1450"
        MinWidth="1250" MinHeight="800"
        Loaded="Window_Loaded" Closing="Window_Closing"
        PreviewKeyDown="Window_PreviewKeyDown"
        Background="{DynamicResource {x:Static SystemColors.ControlBrushKey}}"
        AllowDrop="True" DragEnter="Window_DragEnter" DragOver="Window_DragOver" Drop="Window_Drop">

    <Window.Resources>
        <Thickness x:Key="ControlMarginCompact">0,0,0,0</Thickness>
        <Thickness x:Key="GroupMarginCompact">3,1,3,1</Thickness>
        <Thickness x:Key="InnerGroupPaddingCompact">5,2</Thickness>
        <CornerRadius x:Key="ControlCornerRadius">2</CornerRadius>
        <CornerRadius x:Key="ButtonCornerRadius">3</CornerRadius>
        <Thickness x:Key="SectionMarginCompact">0,2,0,1</Thickness>
        <SolidColorBrush x:Key="AccentBrush" Color="#FF0078D4"/>
        <SolidColorBrush x:Key="SubtleBorderBrush" Color="#FFD0D0D0"/>
        <SolidColorBrush x:Key="LighterBackgroundBrush" Color="#FFF5F5F5"/>
        <SolidColorBrush x:Key="NavHoverBackgroundBrush" Color="#FFE6F2FA"/>
        <SolidColorBrush x:Key="NavSelectedBackgroundBrush" Color="#FFCDE6F7"/>
        <SolidColorBrush x:Key="SeparatorForegroundBrush" Color="#FF606060"/>

        <Style x:Key="NavListBoxItemStyle" TargetType="ListBoxItem" BasedOn="{StaticResource BaseNavListBoxItemStyle}"/>

        <Style x:Key="StandardBaseButtonStyle" TargetType="Button" BasedOn="{StaticResource BaseButtonStyle}">
            <Setter Property="Padding" Value="10,0"/>
            <Setter Property="Margin" Value="5,0,0,0"/>
            <Setter Property="MinWidth" Value="80"/>
            <Setter Property="Height" Value="28"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>

        <Style x:Key="BaseButtonStyleUltraCompact" TargetType="Button" BasedOn="{StaticResource BaseButtonStyle}">
            <Setter Property="Padding" Value="4,1"/>
            <Setter Property="Margin" Value="1"/>
            <Setter Property="MinWidth" Value="50"/>
            <Setter Property="MinHeight" Value="20"/>
            <Setter Property="FontSize" Value="9"/>
        </Style>
        <Style x:Key="BrowseButtonStyleCompact" TargetType="Button" BasedOn="{StaticResource BaseButtonStyleUltraCompact}" />
        <Style x:Key="SelectButtonStyleCompact" TargetType="Button" BasedOn="{StaticResource BaseButtonStyleUltraCompact}">
            <Setter Property="Width" Value="90"/>
            <Setter Property="Margin" Value="0,1,0,1"/>
        </Style>

        <Style x:Key="MainActionButtonStyle" TargetType="Button" BasedOn="{StaticResource BaseButtonStyle}">
            <Setter Property="Padding" Value="6,3"/>
            <Setter Property="Height" Value="28"/>
            <Setter Property="MinWidth" Value="90"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
        </Style>
        <Style x:Key="StartGenerationButtonStyle" TargetType="Button" BasedOn="{StaticResource MainActionButtonStyle}">
            <Setter Property="Background" Value="#FF28A745"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#FF218838"/>
        </Style>
        <Style x:Key="CancelGenerationButtonStyle" TargetType="Button" BasedOn="{StaticResource MainActionButtonStyle}">
            <Setter Property="Background" Value="#FFDC3545"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#FFC82333"/>
        </Style>

        <Style x:Key="SecondaryUtilityButtonStyle" TargetType="Button" BasedOn="{StaticResource BaseButtonStyleUltraCompact}">
            <Setter Property="MinWidth" Value="90"/>
            <Setter Property="Height" Value="26"/>
            <Setter Property="FontSize" Value="9"/>
            <Setter Property="Background" Value="#FFD4D4D4"/>
            <Setter Property="BorderBrush" Value="#FFB0B0B0"/>
        </Style>

        <Style TargetType="GroupBox" BasedOn="{StaticResource BaseGroupBoxStyle}">
            <Setter Property="Padding" Value="{StaticResource InnerGroupPaddingCompact}"/>
            <Setter Property="Margin" Value="{StaticResource GroupMarginCompact}"/>
        </Style>
        <Style TargetType="Expander">
            <Setter Property="Padding" Value="3,1"/>
            <Setter Property="Margin" Value="0,1,0,1"/>
            <Setter Property="BorderBrush" Value="{StaticResource SubtleBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Background" Value="{StaticResource LighterBackgroundBrush}"/>
            <Setter Property="HeaderTemplate">
                <Setter.Value>
                    <DataTemplate>
                        <TextBlock Text="{Binding}" FontWeight="SemiBold" FontSize="10" Margin="0"/>
                    </DataTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="OptionLabelStyleCompact" TargetType="Label">
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,0,1,0"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="FontSize" Value="9"/>
        </Style>
        <Style x:Key="OptionCheckBoxStyleCompact" TargetType="CheckBox">
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,0,1,0"/>
            <Setter Property="FontSize" Value="9"/>
        </Style>
        <Style x:Key="OptionTextBoxStyleCompact" TargetType="TextBox">
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0"/>
            <Setter Property="Height" Value="18"/>
            <Setter Property="MinWidth" Value="20"/>
            <Setter Property="Padding" Value="1,0"/>
            <Setter Property="BorderBrush" Value="{StaticResource SubtleBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontSize" Value="9"/>
        </Style>

        <Style x:Key="StandardComboBoxStyle" TargetType="ComboBox">
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="5,0,0,0"/>
            <Setter Property="Height" Value="28"/>
            <Setter Property="MinWidth" Value="80"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="BorderBrush" Value="{StaticResource SubtleBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
        <Style x:Key="CompactComboBoxStyle" TargetType="ComboBox">
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="{StaticResource ControlMarginCompact}"/>
            <Setter Property="Height" Value="20"/>
            <Setter Property="MinWidth" Value="70"/>
            <Setter Property="BorderBrush" Value="{StaticResource SubtleBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontSize" Value="9"/>
        </Style>

        <Style TargetType="Separator">
            <Setter Property="Margin" Value="0,2,0,2"/>
        </Style>
        <Style x:Key="StandardInputPathBorderStyle" TargetType="Border">
            <Setter Property="BorderBrush" Value="{StaticResource SubtleBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="{StaticResource ButtonCornerRadius}"/>
            <Setter Property="Margin" Value="0,0,5,0"/>
            <Setter Property="Background" Value="{DynamicResource {x:Static SystemColors.WindowBrushKey}}"/>
            <Setter Property="Height" Value="28"/>
        </Style>
        <Style x:Key="StandardInputPathTextBoxStyle" TargetType="TextBox">
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Padding" Value="5,0"/>
            <Setter Property="Foreground" Value="Gray"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="MinWidth" Value="200"/>
            <Setter Property="FontSize" Value="11"/>
        </Style>

        <Style x:Key="DropBorderStyle" TargetType="Border" BasedOn="{StaticResource BaseDropBorderStyle}">
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
        <Style x:Key="DropTextStyle" TargetType="TextBlock" BasedOn="{StaticResource BaseDropTextStyle}">
            <Setter Property="FontSize" Value="10"/>
        </Style>
    </Window.Resources>

    <Grid Margin="3">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" MinHeight="30"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="60"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Grid Grid.Row="0" Margin="0,0,0,2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <Border Style="{StaticResource StandardInputPathBorderStyle}" Grid.Column="0" AllowDrop="True"
                    DragEnter="Panel_DragEnter" DragLeave="Panel_DragLeave" Drop="Panel_DragDrop">
                <TextBox x:Name="txtFolderPath" Style="{StaticResource StandardInputPathTextBoxStyle}" Text="{Binding SelectedInputPathSummary, Mode=OneWay}" IsReadOnly="True"
                         AllowDrop="True" DragEnter="TextBox_DragEnter" Drop="TextBox_DragDrop"
                         GotFocus="TxtFolderPath_GotFocus" LostFocus="TxtFolderPath_LostFocus"/>
            </Border>
            <Button x:Name="btnBrowseFolder" Style="{StaticResource StandardBaseButtonStyle}" Grid.Column="1" Content="浏览..." Command="{Binding BrowseFolderCommand}"/>
            <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                <ComboBox x:Name="cmbLanguage" Style="{StaticResource StandardComboBoxStyle}" Width="80" ItemsSource="{Binding AvailableLanguages}" SelectedItem="{Binding SelectedLanguage, Mode=TwoWay}" DisplayMemberPath="DisplayName"/>
            </StackPanel>
        </Grid>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" MinWidth="150" MaxWidth="250"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*" MinWidth="200"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="220" MinWidth="215" MaxWidth="300"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" BorderBrush="{StaticResource SubtleBorderBrush}" BorderThickness="0,0,1,0" Background="{StaticResource LighterBackgroundBrush}">
                <ListBox x:Name="navListBox"
         ItemContainerStyle="{StaticResource NavListBoxItemStyle}"
         BorderThickness="0" Background="Transparent"
         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
         SelectedValue="{Binding SelectedNavItem, Mode=TwoWay}"
                    SelectedValuePath="Content">
                 
                    <ListBoxItem Content="创建目录"/>
                    <ListBoxItem Content="直接命名"/>
                    <ListBoxItem Content="文件处理" IsEnabled="False"/>
                    <ListBoxItem Content="EXIF 移除"/>
                    <ListBoxItem Content="EXIF 写入"/>
                    <ListBoxItem Content="媒体生成" IsEnabled="False"/>
                    <ListBoxItem Content="生成视频"/>
                    <ListBoxItem Content="生成连拍"/>
                    <ListBoxItem Content="生成动画"/>
                </ListBox>
            </Border>

            <GridSplitter Grid.Column="1" Width="3" HorizontalAlignment="Center" VerticalAlignment="Stretch" Background="LightGray" ShowsPreview="True"/>

            <ScrollViewer Grid.Column="2" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" Margin="2,0,0,0" Padding="0,0,2,0">
                <Border BorderBrush="{StaticResource SubtleBorderBrush}" BorderThickness="1" Background="White" Padding="6" >
                    <ContentControl x:Name="contentArea" HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch" Content="{Binding CurrentView}"/>
                </Border>
            </ScrollViewer>

            <GridSplitter Grid.Column="3" Width="3" HorizontalAlignment="Center" VerticalAlignment="Stretch" Background="LightGray" ShowsPreview="True"/>

            <Grid Grid.Column="4" Margin="2,0,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <StackPanel x:Name="ActionButtonsPanel" Grid.Row="0" Orientation="Vertical" HorizontalAlignment="Center" Margin="0,0,0,2"
                            Visibility="{Binding ActionButtonsVisible, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" x:Name="actionButtonsRow1">
                        <Button x:Name="btnStartAction" Content="开始处理" Style="{StaticResource StartGenerationButtonStyle}" Margin="0,0,1,0" HorizontalContentAlignment="Center"
                                Command="{Binding StartProcessingCommand}"/>
                        <Button x:Name="btnCancelAction" Content="取消操作" Style="{StaticResource CancelGenerationButtonStyle}" Margin="1,0,0,0" HorizontalContentAlignment="Center"
                                Command="{Binding CancelProcessingCommand}" IsEnabled="{Binding CanCancelProcessing, Mode=OneWay}"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,1,0,0">
                        <Button x:Name="btnRestoreLastParams" Content="恢复上一次参数" Style="{StaticResource SecondaryUtilityButtonStyle}" Margin="0,0,1,0" Height="26" Command="{Binding ResetParamsCommand}"/>
                        <Button x:Name="btnRestoreDefaults" Content="恢复默认参数" Style="{StaticResource SecondaryUtilityButtonStyle}" Margin="1,0,0,0" Height="26" Command="{Binding RestoreDefaultsCommand}"/>
                    </StackPanel>
                </StackPanel>

                <GroupBox x:Name="SourceSelectionDropZone" Grid.Row="1" Header="源文件/文件夹" Padding="1" Margin="0,0,0,1"
                          Visibility="{Binding SourceSelectionVisible, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid Grid.Row="0" HorizontalAlignment="Stretch"
                              Width="{Binding ActualWidth, ElementName=actionButtonsRow1, Mode=OneWay}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button x:Name="btnSelectFolder" Grid.Column="0" Content="📂 文件夹" Style="{StaticResource MainActionButtonStyle}" Margin="0,0,1,0" HorizontalContentAlignment="Center"
                                    Command="{Binding SelectFolderCommand}"/>
                            <Button x:Name="btnSelectImages" Grid.Column="1" Content="🖼️ 图片" Style="{StaticResource MainActionButtonStyle}" Margin="1,0,0,0" HorizontalContentAlignment="Center"
                                    Command="{Binding SelectImagesCommand}"/>
                        </Grid>
                        <Border Grid.Row="1" Style="{StaticResource DropBorderStyle}" Height="84" AllowDrop="True"
                                DragEnter="Panel_DragEnter" DragLeave="Panel_DragLeave" Drop="Panel_DragDrop">
                            <TextBlock Style="{StaticResource DropTextStyle}" FontSize="9" Text="或拖动源到此处"/>
                        </Border>
                    </Grid>
                </GroupBox>

                <GroupBox Grid.Row="2" Header="全局命名设置" Margin="0,1,0,1" x:Name="gbGlobalNamingSettings">
                    <StackPanel x:Name="contentGlobalNamingSettings">
                        <TextBlock Text="名称组合顺序:" FontWeight="SemiBold" FontSize="9" Margin="0,0,0,0"/>
                        <ComboBox x:Name="cmbNameOrder" Style="{StaticResource CompactComboBoxStyle}" SelectedValue="{Binding GlobalNameOrder, Mode=TwoWay}" SelectedValuePath="Content" Margin="0,0,0,2">
                            <ComboBoxItem Content="夹/父/子/名+时间戳+计数器"/>
                            <ComboBoxItem Content="夹/父/子/名+计数器+时间戳"/>
                            <ComboBoxItem Content="计数器+夹/父/子/名+时间戳"/>
                            <ComboBoxItem Content="计数器+时间戳+夹/父/子/名"/>
                            <ComboBoxItem Content="时间戳+夹/父/子/名+计数器"/>
                            <ComboBoxItem Content="时间戳+计数器+夹/父/子/名"/>
                        </ComboBox>
                        <Separator Margin="0,1,0,1"/>
                        <Expander Header="自定义名称组件" IsExpanded="True" Margin="0,1,0,0" Padding="2,1" FontSize="9">
                            <StackPanel Margin="2,1,0,0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" MinWidth="60"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <CheckBox x:Name="chkGlobalFolder" ToolTip="文件夹" Style="{StaticResource OptionCheckBoxStyleCompact}" Content="文件夹" Grid.Column="0" IsChecked="{Binding GlobalNamingOptions.IncludeFolder, Mode=TwoWay}"/>
                                    <TextBox x:Name="txtGlobalFolder" Style="{StaticResource OptionTextBoxStyleCompact}" Text="{Binding GlobalNamingOptions.FolderText, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}" Grid.Column="1" IsEnabled="{Binding IsChecked, ElementName=chkGlobalFolder}"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" MinWidth="60"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <CheckBox x:Name="chkGlobalParentDir" ToolTip="父目录" Style="{StaticResource OptionCheckBoxStyleCompact}" Content="父目录" Grid.Column="0" IsChecked="{Binding GlobalNamingOptions.IncludeParentDir, Mode=TwoWay}"/>
                                    <TextBox x:Name="txtGlobalParentDir" Style="{StaticResource OptionTextBoxStyleCompact}" Text="{Binding GlobalNamingOptions.ParentDirText, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}" Grid.Column="1" IsEnabled="{Binding IsChecked, ElementName=chkGlobalParentDir}"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" MinWidth="60"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <CheckBox x:Name="chkGlobalSubDir" ToolTip="子目录" Style="{StaticResource OptionCheckBoxStyleCompact}" Content="子目录" Grid.Column="0" IsChecked="{Binding GlobalNamingOptions.IncludeSubDir, Mode=TwoWay}"/>
                                    <TextBox x:Name="txtGlobalSubDir" Style="{StaticResource OptionTextBoxStyleCompact}" Text="{Binding GlobalNamingOptions.SubDirText, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}" Grid.Column="1" IsEnabled="{Binding IsChecked, ElementName=chkGlobalSubDir}"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" MinWidth="60"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <CheckBox x:Name="chkGlobalFileName" ToolTip="文件名" Style="{StaticResource OptionCheckBoxStyleCompact}" Content="文件名" Grid.Column="0" IsChecked="{Binding GlobalNamingOptions.IncludeFileName, Mode=TwoWay}"/>
                                    <TextBox x:Name="txtGlobalFileName" Style="{StaticResource OptionTextBoxStyleCompact}" Text="{Binding GlobalNamingOptions.FileNameText, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}" Grid.Column="1" IsEnabled="{Binding IsChecked, ElementName=chkGlobalFileName}"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" MinWidth="60"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <CheckBox x:Name="chkGlobalTimestamp" ToolTip="时间戳" Style="{StaticResource OptionCheckBoxStyleCompact}" Content="时间戳" Grid.Column="0" IsChecked="{Binding GlobalNamingOptions.IncludeTimestamp, Mode=TwoWay}"/>
                                    <Label Style="{StaticResource OptionLabelStyleCompact}" Content="格式:" Grid.Column="1" Margin="2,0,1,0" IsEnabled="{Binding IsChecked, ElementName=chkGlobalTimestamp}"/>
                                    <TextBox x:Name="txtGlobalTimestampFormat" Style="{StaticResource OptionTextBoxStyleCompact}" Text="{Binding GlobalNamingOptions.TimestampFormat, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}" Grid.Column="2" IsEnabled="{Binding IsChecked, ElementName=chkGlobalTimestamp}"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" MinWidth="60"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto" MinWidth="25"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*" MinWidth="25"/>
                                    </Grid.ColumnDefinitions>
                                    <CheckBox x:Name="chkGlobalCounter" ToolTip="计数器" Style="{StaticResource OptionCheckBoxStyleCompact}" Content="计数器" Grid.Column="0" IsChecked="{Binding GlobalNamingOptions.IncludeCounter, Mode=TwoWay}"/>
                                    <Label Style="{StaticResource OptionLabelStyleCompact}" Content="起:" Grid.Column="1" Margin="2,0,1,0" IsEnabled="{Binding IsChecked, ElementName=chkGlobalCounter}"/>
                                    <TextBox x:Name="txtGlobalCounterStart" Style="{StaticResource OptionTextBoxStyleCompact}" Text="{Binding GlobalNamingOptions.CounterStartText, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}" Grid.Column="2" IsEnabled="{Binding IsChecked, ElementName=chkGlobalCounter}"/>
                                    <Label Style="{StaticResource OptionLabelStyleCompact}" Content="格:" Grid.Column="3" Margin="2,0,1,0" IsEnabled="{Binding IsChecked, ElementName=chkGlobalCounter}"/>
                                    <TextBox x:Name="txtGlobalCounterFormat" Style="{StaticResource OptionTextBoxStyleCompact}" Text="{Binding GlobalNamingOptions.CounterFormat, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}" Grid.Column="4" IsEnabled="{Binding IsChecked, ElementName=chkGlobalCounter}"/>
                                </Grid>
                                <Grid Margin="0,0,0,1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" MinWidth="60"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <CheckBox x:Name="chkGlobalSeparator" ToolTip="间隔符" Style="{StaticResource OptionCheckBoxStyleCompact}" Content="间隔符" Grid.Column="0" IsChecked="{Binding GlobalNamingOptions.UseSeparator, Mode=TwoWay}"/>
                                    <Label Style="{StaticResource OptionLabelStyleCompact}" Content="符:" Grid.Column="1" Margin="2,0,1,0" IsEnabled="{Binding IsChecked, ElementName=chkGlobalSeparator}"/>
                                    <TextBox x:Name="txtGlobalSeparatorFormat" Style="{StaticResource OptionTextBoxStyleCompact}" Text="{Binding GlobalNamingOptions.Separator, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}" MaxLength="1" Width="20" Grid.Column="2" IsEnabled="{Binding IsChecked, ElementName=chkGlobalSeparator}" HorizontalAlignment="Left"/>
                                </Grid>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </GroupBox>

                <Expander Grid.Row="3" Header="自定义路径选项 (✔优先可选)" Foreground="#FF39BA1D" Margin="0,1,0,1" IsExpanded="True">
                    <StackPanel Orientation="Vertical" Margin="2,1,0,0">
                        <Grid Margin="{StaticResource SectionMarginCompact}" Grid.IsSharedSizeScope="True">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto" SharedSizeGroup="CustomPathBrowseGroup"/>
                            </Grid.ColumnDefinitions>
                            <CheckBox x:Name="chkCustomBackupPath" Style="{StaticResource OptionCheckBoxStyleCompact}" Content="备份|保存" Grid.Column="0" IsChecked="{Binding CustomPathOptions.UseCustomBackupPath, Mode=TwoWay}"/>
                            <TextBox x:Name="txtCustomBackupPath" Style="{StaticResource OptionTextBoxStyleCompact}" Grid.Column="1" IsEnabled="{Binding IsChecked, ElementName=chkCustomBackupPath}" Margin="3,0,3,0" Text="{Binding CustomPathOptions.CustomBackupPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                            <Button x:Name="btnBrowseCustomBackupPath" Style="{StaticResource BrowseButtonStyleCompact}" Grid.Column="2" Content="浏览..." Command="{Binding BrowseCustomPathCommand}" CommandParameter="BackupPath" IsEnabled="{Binding IsChecked, ElementName=chkCustomBackupPath}"/>
                        </Grid>
                        <Grid Margin="{StaticResource SectionMarginCompact}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto" SharedSizeGroup="CustomPathBrowseGroup"/>
                            </Grid.ColumnDefinitions>
                            <CheckBox x:Name="chkCustomImageOutputPath" Style="{StaticResource OptionCheckBoxStyleCompact}" Content="图像|保存" Grid.Column="0" IsChecked="{Binding CustomPathOptions.UseCustomImageOutputPath, Mode=TwoWay}"/>
                            <TextBox x:Name="txtCustomImageOutputPath" Style="{StaticResource OptionTextBoxStyleCompact}" Grid.Column="1" IsEnabled="{Binding IsChecked, ElementName=chkCustomImageOutputPath}" Margin="3,0,3,0" Text="{Binding CustomPathOptions.CustomImageOutputPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                            <Button x:Name="btnBrowseCustomImageOutputPath" Style="{StaticResource BrowseButtonStyleCompact}" Grid.Column="2" Content="浏览..." Command="{Binding BrowseCustomPathCommand}" CommandParameter="ImageOutputPath" IsEnabled="{Binding IsChecked, ElementName=chkCustomImageOutputPath}"/>
                        </Grid>
                        <Grid Margin="{StaticResource SectionMarginCompact}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto" SharedSizeGroup="CustomPathBrowseGroup"/>
                            </Grid.ColumnDefinitions>
                            <CheckBox x:Name="chkCustomVideoOutputPath" Style="{StaticResource OptionCheckBoxStyleCompact}" Content="媒体|保存" Grid.Column="0" IsChecked="{Binding CustomPathOptions.UseCustomVideoOutputPath, Mode=TwoWay}"/>
                            <TextBox x:Name="txtCustomVideoOutputPath" Style="{StaticResource OptionTextBoxStyleCompact}" Grid.Column="1" IsEnabled="{Binding IsChecked, ElementName=chkCustomVideoOutputPath}" Margin="3,0,3,0" Text="{Binding CustomPathOptions.CustomVideoOutputPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                            <Button x:Name="btnBrowseCustomVideoOutputPath" Style="{StaticResource BrowseButtonStyleCompact}" Grid.Column="2" Content="浏览..." Command="{Binding BrowseCustomPathCommand}" CommandParameter="VideoOutputPath" IsEnabled="{Binding IsChecked, ElementName=chkCustomVideoOutputPath}"/>
                        </Grid>
                    </StackPanel>
                </Expander>

                <GroupBox Grid.Row="4" Header="通用处理选项" Margin="0,1,0,1">
                    <StackPanel>
                        <TextBlock Text="图像输出格式:" FontWeight="SemiBold" FontSize="9" Margin="0,0,0,0"/>
                        <ComboBox x:Name="cmbOutputFormat_Shared" Style="{StaticResource CompactComboBoxStyle}" SelectedValue="{Binding OutputImageFormat, Mode=TwoWay}" SelectedValuePath="Content" Margin="0,0,0,2">
                            <ComboBoxItem Content="JPEG"/>
                            <ComboBoxItem Content="PNG"/>
                            <ComboBoxItem Content="TIFF"/>
                            <ComboBoxItem Content="BMP"/>
                            <ComboBoxItem Content="WEBP"/>
                        </ComboBox>
                        <StackPanel Orientation="Horizontal" x:Name="pnlJpegQuality_Shared" Margin="0,0,0,2" Visibility="{Binding IsJpegOutput, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <TextBlock Text="JPEG 质量:" FontWeight="SemiBold" FontSize="9" VerticalAlignment="Center" Margin="0,0,0,0"/>
                            <Slider x:Name="sliderJpegQuality_Shared" Width="100" Minimum="1" Maximum="100" Value="{Binding JpegQuality, Mode=TwoWay}" VerticalAlignment="Center" Margin="5,0,5,0"/>
                            <TextBlock Text="{Binding Value, ElementName=sliderJpegQuality_Shared, StringFormat={}{0:F0}}" FontWeight="SemiBold" FontSize="9" VerticalAlignment="Center"/>
                        </StackPanel>
                        <Separator Margin="0,1,0,1"/>
                        <TextBlock Text="备份:" FontWeight="SemiBold" FontSize="9" Margin="0,1,0,0"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,1">
                            <CheckBox x:Name="chkGlobalBackupEnable" Style="{StaticResource OptionCheckBoxStyleCompact}" Content="启用备份" IsChecked="{Binding GeneralEnableBackup, Mode=TwoWay}"/>
                            <CheckBox x:Name="chkGlobalBackupDisable" Style="{StaticResource OptionCheckBoxStyleCompact}" Content="禁用" Margin="8,1,1,1" ToolTip="如果勾选此项，将覆盖&quot;启用备份&quot;并强制不进行备份。" IsChecked="{Binding GeneralEnableBackup, Converter={StaticResource InverseBooleanConverter}, Mode=TwoWay}"/>
                        </StackPanel>
                        <Separator Margin="0,1,0,1"/>
                        <TextBlock Text="原文件处理:" FontWeight="SemiBold" FontSize="9" Margin="0,1,0,0"/>
                        <ComboBox x:Name="cmbOriginalFileAction_Shared" Style="{StaticResource CompactComboBoxStyle}" SelectedIndex="{Binding OriginalFileActionIndex, Mode=TwoWay}" Margin="0,0,0,2">
                            <ComboBoxItem Content="原地处理 (如果可能)" ToolTip="如果处理工具支持原地修改，则直接修改原文件"/>
                            <ComboBoxItem Content="处理到新文件，保留原文件" ToolTip="处理结果输出到新文件，原文件不做改动"/>
                            <ComboBoxItem Content="处理到新文件，删除原文件" ToolTip="处理结果输出到新文件，然后删除原始文件"/>
                        </ComboBox>
                        <TextBlock Text="(仅当未启用备份且未使用自定义输出路径时生效)" FontSize="8" Foreground="Gray" Margin="5,0,0,2" TextWrapping="Wrap"/>
                        <Separator Margin="0,1,0,1"/>
                        <TextBlock Text="图像处理工具:" FontWeight="SemiBold" FontSize="9" Margin="0,1,0,0"/>
                        <ComboBox x:Name="cmbProcessingTool_Shared" Style="{StaticResource CompactComboBoxStyle}" SelectedValue="{Binding SelectedExifToolTag, Mode=TwoWay}" SelectedValuePath="Tag" Margin="0,0,0,2">
                            <ComboBoxItem Content="ExifTool" Tag="ExifTool"/>
                            <ComboBoxItem Content="ImageMagick" Tag="ImageMagick" IsEnabled="False" ToolTip="暂不支持"/>
                        </ComboBox>
                        <TextBlock Text="(选择用于EXIF处理的主要工具)" FontSize="8" Foreground="Gray" Margin="5,0,0,2" TextWrapping="Wrap"/>
                        <Separator Margin="0,1,0,1"/>
                        <TextBlock Text="媒体输出选项:" FontWeight="SemiBold" FontSize="9" Margin="0,1,0,0"/>
                        <CheckBox x:Name="chkTimestampSubfolder_Media" Style="{StaticResource OptionCheckBoxStyleCompact}" Content="媒体输出到时间戳子文件夹" IsChecked="{Binding UseTimestampSubfolderForMedia, Mode=TwoWay}"/>
                        <TextBlock Text="(如果主窗口启用了时间戳且未使用自定义视频输出路径)" FontSize="8" Foreground="Gray" Margin="5,0,0,2" TextWrapping="Wrap"/>
                    </StackPanel>
                </GroupBox>
            </Grid>
        </Grid>

        <Grid Grid.Row="2" Margin="0,2,0,1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Label x:Name="lblProgressHintLabel" Content="处理进度>>>" Grid.Column="0" VerticalAlignment="Center" Padding="3,0,2,0" FontSize="9"/>
            <ProgressBar x:Name="progressBar" Grid.Column="1" Height="14" Minimum="0" Maximum="100" Margin="3,0,0,0"
                         IsIndeterminate="{Binding IsProgressIndeterminate, Mode=OneWay}" Value="{Binding ProgressValue, Mode=OneWay}">
                <ProgressBar.Template>
                    <ControlTemplate TargetType="ProgressBar">
                        <Grid Height="14">
                            <Border BorderThickness="1" CornerRadius="7" Background="#FFE0E0E0"/>
                            <Grid x:Name="PART_Indicator_ParentGrid" ClipToBounds="True" Margin="1">
                                <Rectangle Fill="{DynamicResource AccentBrush}" Height="12" RadiusX="6" RadiusY="6" HorizontalAlignment="Left" x:Name="PART_Indicator">
                                    <Rectangle.Width>
                                        <MultiBinding Converter="{StaticResource ProgressToWidthMultiConverter}">
                                            <Binding RelativeSource="{RelativeSource TemplatedParent}" Path="Value"/>
                                            <Binding ElementName="PART_Indicator_ParentGrid" Path="ActualWidth"/>
                                        </MultiBinding>
                                    </Rectangle.Width>
                                </Rectangle>
                            </Grid>
                        </Grid>
                    </ControlTemplate>
                </ProgressBar.Template>
            </ProgressBar>
        </Grid>
        <Grid Grid.Row="3" Margin="0,0,0,0">
            <Label x:Name="LogLabelElement" Content="处理日志:" Padding="3,0,0,0" VerticalAlignment="Center" FontWeight="SemiBold" HorizontalAlignment="Left" FontSize="9"/>
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                <Button x:Name="btnSaveLog" Content="保存日志" Style="{StaticResource BaseButtonStyleUltraCompact}" MinWidth="45" Padding="3,1" Height="18" FontSize="8" Command="{Binding SaveLogCommand}"/>
                <Button x:Name="btnClearLog" Content="清除日志" Style="{StaticResource BaseButtonStyleUltraCompact}" MinWidth="45" Padding="3,1" Height="18" FontSize="8" Command="{Binding ClearLogCommand}"/>
            </StackPanel>
        </Grid>
        <TextBox x:Name="TbLog" Grid.Row="4" VerticalScrollBarVisibility="Auto" IsReadOnly="True" AcceptsReturn="True" TextWrapping="Wrap" FontFamily="Consolas" FontSize="8" BorderThickness="1" BorderBrush="{StaticResource SubtleBorderBrush}" Padding="2" Margin="0,0,0,2" Text="{Binding LogContent, Mode=OneWay}"/>
        <StatusBar Grid.Row="5" Height="18" VerticalAlignment="Center" FontSize="8">
            <StatusBarItem>
                <TextBlock x:Name="lblProcessStatus" Text="{Binding StatusText, Mode=OneWay}"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock x:Name="lblImageCount" Text="{Binding CountsSummaryText, Mode=OneWay}"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock x:Name="lblProgressHint" Text="{Binding ProgressSummaryText, Mode=OneWay}"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock x:Name="lblStartTime" Text="{Binding StartTimeText, Mode=OneWay}"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock x:Name="lblElapsedTime" Text="{Binding ElapsedTimeText, Mode=OneWay}"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock x:Name="lblEndTime" Text="{Binding EndTimeText, Mode=OneWay}"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock x:Name="lblTotalTime" Text="{Binding TotalTimeText, Mode=OneWay}"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock x:Name="lblConcurrentTasks" Text="{Binding ActiveTasksText, Mode=OneWay}"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem DockPanel.Dock="Right">
                <TextBlock x:Name="lblRealTimeClock" Text="00:00:00"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>